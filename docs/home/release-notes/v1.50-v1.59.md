# Release notes

## Version 1.58

!!! warning

    This version must be installed before proceeding with the next update.

!!! tip ""
    Helm chart version 1.58.0

### Clickhouse migration

In current release we moved from standalone Clickhouse container to the Clickhouse cluster that will be controlled by [Altinity clickhouse operator](https://github.com/Altinity/clickhouse-operator).  
We automated process of transferring data from the standalone version to the cluster version of clickhouse, migration will be executed during upgrade process.

Things that you have keep in mind before upgrading process:

- Migration time depends on resources(mostly on CPU and Disk IO) allocated for Clickhouse instances, during our tests we've mentioned average speed 50Gb per hour for instances with 4CPU/16Gb RAM

- It's necessary **not to set** flags as `--wait` and `--timeout` during upgrading process because of migration time

- The new ClickHouse cluster must have 25% more disk space than the standalone variant.

- Optional: We've developed [a tool that checks consistency of data](../troubleshooting/sanity-check.md), you could use it before and after the upgrading process and compare results of those checks just to be sure that everything went as expected

#### Following steps

  1. Install the [odm-ops](../helm/how-to-deploy.md#deployment-process) helm chart, it will install the Altinity ClickHouse operator with pre-configured settings.

  2. Copy the parameters **you use** from ClickHouse to Altinity ClickHouse (requests, limits, disk size +25%, etc.). You can refer to the example `migrate-clickhouse-to-clickhouse-cluster.yaml`.

  3. Start the ODM update with `helm upgrade ...`.  

  4. A job named `odm-clickhouse-helper` will appear in Kubernetes, and it will handle the migration.  

  5. During the ClickHouse migration, ODM will continue to operate, but all writes to ClickHouse will be blocked.  

  6. Wait until the `odm-clickhouse-helper` job completes, indicating that the migration is done.  

  7. Verify the data in ODM.  
  
  8. Disable `clickhouse` and `clickhouseMigration` in Helm values. You can refer to the example `disable-old-clickhouse-after-upgrade.yaml`.

  9. Update ODM one last time with `helm upgrade ...`. This will disable the old ClickHouse.

### Helm examples changes

- New examples for different ODM configuration options have been added to the `examples` helm chart directory, and all old ones have been updated.

- Additionally, recommendations for computing resources have been included.

### Helm configuration changes

- From this release, we are using fully original Docker images for the OSS components of ODM. It is not recommended to update them independently.

    From:

    ```yaml
    mysql:
      image:
        registry: 091468197733.dkr.ecr.us-east-1.amazonaws.com
        repository: genestack/mysql

    mailcatcher:
      image:
        registry: 091468197733.dkr.ecr.us-east-1.amazonaws.com
        repository: genestack/mailcatcher

    clickhouse:
      image:
        registry: 091468197733.dkr.ecr.us-east-1.amazonaws.com
        repository: genestack/clickhouse

    nginx:
      image:
        registry: 091468197733.dkr.ecr.us-east-1.amazonaws.com
        repository: genestack/nginx
    ```

    To:

    ```yaml
    mysql:
      image:
        registry: docker.io
        repository: mysql

    mailcatcher:
      image:
        registry: docker.io
        repository: dockage/mailcatcher

    clickhouse:
      image:
        registry: docker.io
        repository: clickhouse/clickhouse-server

    nginx:
      image:
        registry: docker.io
        repository: nginxinc/nginx-unprivileged
    ```

- Now you can mount any file with any content into any container in ODM! For example, your certificates. This feature required adding the full path in all existing ODM configuration files.

    From:

    ```yaml
    core:
      configurationFiles:
        "application.yaml":

    applications:
      configurationFiles:
        "application.yaml":
        "microsoft.openid.ini":
        "okta.openid.ini":
        "google.openid.ini":

    mysql:
      configurationFiles:
        "genestack.cnf":

    funcFile:
      configurationFiles:
        "application.yaml":

    funcJob:
      configurationFiles:
        "application.yaml":

    linkService:
      configurationFiles:
        "application.yaml":

    clickhouse:
      configurationFiles:
        "config.yaml":
        "users.yaml":

    nginx:
      configurationFiles:
        "odm.conf":
        "proxy-pass-parameters.conf":
    ```

    To:

    ```yaml
    core:
      files:
        "/var/lib/genestack/properties/application.yaml":

    applications:
      files:
        "/var/lib/genestack/properties/application.yaml":
        "/var/lib/genestack/properties/microsoft.openid.ini":
        "/var/lib/genestack/properties/okta.openid.ini":
        "/var/lib/genestack/properties/google.openid.ini":

    mysql:
      files:
        "/etc/mysql/conf.d/genestack.cnf":

    funcFile:
      files:
        "/app/config/application.yaml":

    funcJob:
      files:
        "/app/config/application.yaml":

    linkService:
      files:
        "/app/config/application.yaml":

    clickhouse:
      files:
        "/etc/clickhouse-server/config.d/config.yaml":
        "/etc/clickhouse-server/users.d/users.yaml":

    nginx:
      files:
        "/etc/nginx/conf.d/odm.conf":
        "/etc/nginx/conf.d/proxy-pass-parameters.conf":
    ```

- The AWS credentials for connecting to S3 in `core` and `applications` have been removed. If you have these parameters, you can safely delete them.

    ```yaml
    core:
      files:
        "/var/lib/genestack/properties/application.yaml":
          backend:
            aws:
              region: ""
              endpoint:
                url: ""
              access:
                key: ""
              secret:
                key: ""
    ```

    !!! danger

        Important! The AWS region in the `application` must remain! You can delete only the `endpoint`, `access` and `secret` parameters.

    ```yaml
    applications:
      files:
        "/var/lib/genestack/properties/application.yaml":
          frontend:
            aws:
              region: "{{ .Values.credentials.awsS3Region }}"
              endpoint:
                url: ""
              access:
                key: ""
              secret:
                key: ""
    ```

- Configuration file `settings.py.local` has been removed. If you are using it, you can safely delete it.

    ```yaml
    core:
      files:
        "settings.py.local":
    ```

- The previously added `BusyBox` image for `ClickHouse` has been removed. If you are using it, you can safely delete it.

    ```yaml
    clickhouse:
      busyboxImage:
        registry: docker.io
        repository: busybox
        tag: 1.36.1
    ```

## Version 1.57

!!! warning

    This version must be installed before proceeding with the next update.

!!! tip ""
    Helm chart version 1.57.0

### Helm configuration changes

- Removed the link to the database for the service `func-file`. If you have it in your `values.yaml`, then you can safely remove the `spring` map completely.

    ```yaml
    funcFile:
      configurationFiles:
        "application.yaml":
          spring:
            datasource:
              # -- Mysql jdbc URL
              url: "jdbc:mysql://..."
    ```

- For the Clickhouse `busybox` image, the ability to set the repository and version has been added.

    ```yaml
    clickhouse:
      busyboxImage:
        # -- Image registry
        registry: docker.io
        # -- Image repository
        repository: busybox
        # -- Image tag
        tag: 1.36.1
    ```

## Version 1.56

!!! tip ""
    Helm chart version 1.56.1

### Export metrics to Genestack

Fluent-bit was introduced as an extra service tasked with collecting and dispatching metrics in Prometheus format to a Genestack.

These metrics encompass technical and/or product-related data, devoid of any sensitive information.

If you wish to deactivate this functionality, you can do so by configuring the following parameter:

```yaml
fluent-bit:
  enabled: false
```

### Helm configuration changes

Now organization name and hostname are in a `global` section:

From:

```yaml
odmFrontendHostname: odm.local
applications:
  configurationFiles:
    "application.yaml":
      frontend:
        ui:
          organization:
            name: "Genestack"
```

To:

```yaml
global:
  hostname: odm.local
  organizationName: "Genestack"
```

## Version 1.55

!!! tip ""
    Helm chart version 1.55.4

### Configure ODM usage together with encrypted S3 bucket (SSE-KMS and SSE-S3 only)

#### Introduction

!!! attention ""
    You can find configuration examples in the ODM Helm chart.

In case you have several AWS credentials in your configuration, you need to modify only the credentials for
accessing the bucket in specified as `frontend.aws.bucket`.

#### SSE-KMS

To enable uploading into an SSE-KMS encrypted bucket, you need to customize `func-file` configuration.
The following configuration example uses a bucket encrypted by SSE-KMS with the name `<BUCKET_NAME>`.
The bucket configuration should specify the algorithm `aws:kms` as `preferredAlgorithm`. Additionally,
the property `kmsCmkId` should be added with a value equal to key id `arn:aws:kms:...` if the bucket policy
requires this key to be explicitly send on PUT request. The `func-file` section in the configuration
should look like this:

#### SSE-S3

The SSE-S3 encryption type is default to the most buckets. To force ODM request
this type of encryption from S3 provider for `<BUCKET_NAME>`, you need to specify
the `preferredAlgorithm` property with the value `AES256`:

#### On `storage_config` section configuration in `func-file`

Keep in mind that `func-file` reads the `storage_config` section sequentially. You can create specific configurations
for individual buckets, e.g., if one has SSE-KMS encryption while others do not. To do this, as the first item in
the list, you'll need to specify the bucket with the specific configuration and its name. Then, provide the general
configuration for the other buckets using the wildcard symbol `*`. ODM will only upload files to the bucket, specified
as `frontend.aws.bucket` property, regardless to `storage_config` section.

### Genestack pod separation

Example on the image section, but it's applicable for sections with backend/frontend separation.

ApplicationSettings changes showed separately:

From:

```yaml
genestack:
  image:
    backend:
      registry: 091468197733.dkr.ecr.us-east-1.amazonaws.com
      repository: genestack/core
      pullPolicy: Always
      pullSecrets: []
    frontend:
      registry: 091468197733.dkr.ecr.us-east-1.amazonaws.com
      repository: genestack/applications
      pullPolicy: Always
      pullSecrets: []
```

To:

```yaml
core:
  image:
    registry: 091468197733.dkr.ecr.us-east-1.amazonaws.com
    repository: genestack/core
    pullPolicy: Always
    pullSecrets: []

applications:
  image:
    registry: 091468197733.dkr.ecr.us-east-1.amazonaws.com
    repository: genestack/applications
    pullPolicy: Always
    pullSecrets: []
```

### Application settings rework

From:

```yaml
genestack:
  applicationSettings:
    backend:
      properties:
        # backend.properties file content
      propertiesAuth:
        # backend-credentials.properties file content
      propertiesLimits:
        # limits.yaml file content
      predefinedSystemUsers:
        # token and password for technical odm users
      predefinedUsers:
        # predefined-users.json file content
    frontend:
      properties:
        # frontend.properties file content
        "google.openid.ini":
          # google.openid.ini file content
        "microsoft.openid.ini":
          # microsoft.openid.ini file content
        "okta.openid.ini":
          # okta.openid.ini file content
      propertiesAuth:
        # frontend-credentials.properties file content
      monitoringThresholds:
        # monitoring-thresholds.yaml file content
    saml:
      # saml directory content
```

To:

```yaml

core:
  configurationFiles:
    "application.yaml":
      # backend.properties and backend-credentials.properties files content in YAML format
    "settings.py.local":
      # settings.py.local file content
  secretFiles:
    # saml directory content

applications:
  configurationFiles:
    "application.yaml":
    # frontend.properties and frontend-credentials.properties files content in YAML format
    "google.openid.ini":
    # google.openid.ini file content
    "microsoft.openid.ini":
    # microsoft.openid.ini file content
    "okta.openid.ini":
    # okta.openid.ini file content
```

### High-level paths renaming in values.yaml

#### Solr

From:

```yaml
index: {}  # Solr configuration
```

To:

```yaml
solr: {}  # Solr configuration
```

#### Clickhouse

From:

```yaml
txIndex: {}  # Clickhouse configuration
```

To:

```yaml
clickhouse: {}  # Clickhouse configuration
```

#### Mysql

From:

```yaml
db: {}  # Mysql configuration
```

To:

```yaml
mysql: {}  # Mysql configuration
```

#### Nginx

From:

```yaml
proxy: {}  # Nginx configuration
```

To:

```yaml
nginx: {}  # Nginx configuration
```
